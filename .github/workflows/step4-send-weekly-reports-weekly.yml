# Step 4 — Send Weekly Reports (Weekly)
#
# Pipeline order: step1 → step2 → step3 → step4. Schedule: weekly (Monday 14:00 UTC).
#
# TICKET-016: Weekly Digest Cron Job (GitHub Actions)
# Runs every Monday at 14:00 UTC (after daily incidents at 13:00 UTC) so the
# most recent daily incident job has completed before we generate and send reports.
# Triggers the deployed API to generate reports for the previous week and send emails.
#
# Requires repo secrets:
#   CRON_SECRET – must match CRON_SECRET in Vercel env (for Authorization: Bearer)
#   SITE_URL – production base URL (e.g. https://your-app.vercel.app)

name: Step 4 – Send Weekly Reports (Weekly)

on:
  schedule:
    # Monday 14:00 UTC (1h after daily incidents at 13:00 UTC)
    - cron: "0 14 * * 1"
  workflow_dispatch:

jobs:
  send-weekly-reports:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Invoke weekly reports API
        env:
          SITE_URL: ${{ secrets.SITE_URL }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          if [ -z "$SITE_URL" ] || [ -z "$CRON_SECRET" ]; then
            echo "Missing SITE_URL or CRON_SECRET in repo secrets"
            exit 1
          fi
          resp=$(curl -s -w "\n%{http_code}" -H "Authorization: Bearer $CRON_SECRET" "${SITE_URL}/api/cron/send-weekly-reports")
          body=$(echo "$resp" | head -n -1)
          code=$(echo "$resp" | tail -n 1)
          echo "$body" | head -c 2000
          echo ""
          echo "HTTP $code"
          if [ "$code" != "200" ]; then
            exit 1
          fi
