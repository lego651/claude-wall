# Weekly Step 2 — Send Firm Weekly Reports
#
# Pipeline order: daily-step1/2/3 (daily) → weekly-step1 → weekly-step2. Schedule: weekly (Sunday 8:00 UTC).
#
# Runs every Sunday at 8:00 UTC. Sends digest emails for the current week (Mon–Sun UTC).
# Weekly Step 1 (Sunday 7:00 UTC) populates firm_weekly_reports for that week first.
#
# Requires repo secrets:
#   CRON_SECRET – must match CRON_SECRET in Vercel env (for Authorization: Bearer)
#   SITE_URL – production base URL (e.g. https://your-app.vercel.app)

name: Weekly Step 2 – Send Firm Weekly Reports

on:
  schedule:
    # Sunday 8:00 UTC
    - cron: "0 8 * * 0"
  workflow_dispatch:

jobs:
  send-weekly-reports:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Invoke weekly reports API
        env:
          SITE_URL: ${{ secrets.SITE_URL }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          if [ -z "$SITE_URL" ] || [ -z "$CRON_SECRET" ]; then
            echo "Missing SITE_URL or CRON_SECRET in repo secrets"
            exit 1
          fi
          resp=$(curl -s -w "\n%{http_code}" -H "Authorization: Bearer $CRON_SECRET" "${SITE_URL}/api/cron/send-weekly-reports")
          body=$(echo "$resp" | head -n -1)
          code=$(echo "$resp" | tail -n 1)
          echo "$body" | head -c 2000
          echo ""
          echo "HTTP $code"
          if [ "$code" != "200" ]; then
            exit 1
          fi
