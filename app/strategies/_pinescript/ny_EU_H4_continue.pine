//@version=5
indicator("EU 10-14 Signal / 14-18 Trade Test (UTC) - Custom H4 via 1H", overlay=true, max_lines_count=500, max_labels_count=500)

//====================================================
// Inputs
//====================================================
tpPips      = input.int(14, "TP (pips)", minval=1)
slPips      = input.int(14, "SL (pips)", minval=1)

showLines   = input.bool(true, "Draw TP / SL lines")
showLabels  = input.bool(true, "Draw labels")
showTable   = input.bool(true, "Show results table")

// UTC epoch ms defaults:
// 2025-01-01 00:00 UTC => 1735689600000
// 2025-12-31 23:59 UTC => 1767225540000
startDate   = input.time(defval=1735689600000, title="Start date (UTC)")
endDate     = input.time(defval=1767225540000, title="End date (UTC)")

tz = "UTC"

//====================================================
// Guards: EURUSD only (common TV formats: OANDA:EURUSD, FX:EURUSD, etc.)
//====================================================
isEU = (syminfo.basecurrency == "EUR" and syminfo.currency == "USD") or str.contains(syminfo.ticker, "EURUSD")

//====================================================
// Helpers
//====================================================
inRange(t) => t >= startDate and t <= endDate
pct(num, den) => den == 0 ? na : 100.0 * num / den

// pip sizing for EURUSD (mintick often 0.00001, pip = 0.0001)
pip = syminfo.mintick * 10.0
tpDist = tpPips * pip
slDist = slPips * pip

//====================================================
// Pull 1-hour data (timeframe-independent)
//====================================================
tfEval = "60"

o1 = request.security_lower_tf(syminfo.tickerid, tfEval, open)
h1 = request.security_lower_tf(syminfo.tickerid, tfEval, high)
l1 = request.security_lower_tf(syminfo.tickerid, tfEval, low)
c1 = request.security_lower_tf(syminfo.tickerid, tfEval, close)
t1 = request.security_lower_tf(syminfo.tickerid, tfEval, time)

//====================================================
// State for 10-14 signal block and 14-18 trade block (custom H4 windows)
//====================================================
var bool  buildingSignal = false
var float sigOpen  = na
var float sigClose = na

var bool  buildingTrade = false
var float tradeOpen = na
var float tradeHigh = na
var float tradeLow  = na

var bool  tradeActive = false
var bool  isLong = false
var float entryPrice = na
var float tp = na
var float sl = na
var int   startT = na
var int   endT   = na

//====================================================
// Stats
//====================================================
var int longW = 0
var int longL = 0
var int longN = 0
var int shortW = 0
var int shortL = 0
var int shortN = 0

//====================================================
// Core Logic (1-hour resolution loop)
//====================================================
int sz = array.size(t1)

if not isEU and barstate.islast
    if showLabels
        label.new(time, close, "WARNING: This script is intended for EURUSD only.", xloc=xloc.bar_time, style=label.style_label_left, color=color.orange, textcolor=color.white)

if isEU and sz > 0
    for i = 0 to sz - 1
        int mt = array.get(t1, i)
        if not inRange(mt)
            continue

        float mo = array.get(o1, i)
        float mh = array.get(h1, i)
        float ml = array.get(l1, i)
        float mc = array.get(c1, i)

        int hr = hour(mt, tz)
        int mi = minute(mt, tz)

        // ---------------------------
        // Build SIGNAL block: 10:00 -> 14:00 UTC (hours 10,11,12,13)
        // Start at 10:00
        if hr == 10 and mi == 0
            buildingSignal := true
            sigOpen := mo
            sigClose := mc

        // Update close through 13:00 bar
        if buildingSignal and (hr >= 10 and hr <= 13) and mi == 0
            sigClose := mc

        // Finalize signal when we reach 14:00
        if buildingSignal and hr == 14 and mi == 0
            buildingSignal := false

            // Determine direction: bullish => long, else short (includes doji => short)
            isLong := sigClose > sigOpen

            // ---------------------------
            // Start TRADE block at 14:00 (hours 14,15,16,17)
            // Entry at 14:00 open
            if not tradeActive
                tradeActive := true
                buildingTrade := true

                entryPrice := mo
                startT := mt
                endT := mt + 4 * 60 * 60 * 1000   // 14:00 -> 18:00 UTC

                tp := isLong ? entryPrice + tpDist : entryPrice - tpDist
                sl := isLong ? entryPrice - slDist : entryPrice + slDist

                tradeOpen := entryPrice
                tradeHigh := mh
                tradeLow  := ml

                if showLabels
                    label.new(startT, entryPrice, isLong ? "Aim: LONG (10-14 bull)" : "Aim: SHORT (10-14 not bull)", xloc=xloc.bar_time, style=isLong ? label.style_label_up : label.style_label_down, color=isLong ? color.green : color.red, textcolor=color.white)

                if showLines
                    line.new(startT, tp, endT, tp, xloc=xloc.bar_time, color=color.green, width=2)
                    line.new(startT, sl, endT, sl, xloc=xloc.bar_time, color=color.red, width=2)

        // ---------------------------
        // Accumulate TRADE block highs/lows (14,15,16,17)
        if tradeActive and buildingTrade and (hr >= 14 and hr <= 17) and mi == 0
            tradeHigh := na(tradeHigh) ? mh : math.max(tradeHigh, mh)
            tradeLow  := na(tradeLow)  ? ml : math.min(tradeLow,  ml)

        // ---------------------------
        // Finalize & evaluate at 18:00
        if tradeActive and buildingTrade and hr == 18 and mi == 0
            buildingTrade := false

            bool hitTP = isLong ? (tradeHigh >= tp) : (tradeLow <= tp)
            bool hitSL = isLong ? (tradeLow <= sl)  : (tradeHigh >= sl)

            if hitTP or hitSL
                bool win = hitTP and not hitSL  // both in-window => FAIL (conservative)

                if win
                    if isLong
                        longW += 1
                    else
                        shortW += 1
                else
                    if isLong
                        longL += 1
                    else
                        shortL += 1

                if showLabels
                    label.new(mt, win ? tp : sl, win ? "WIN" : "FAIL", xloc=xloc.bar_time, style=label.style_label_left, color=win ? color.green : color.red, textcolor=color.white)
            else
                // No result by 18:00
                if isLong
                    longN += 1
                else
                    shortN += 1

                if showLabels
                    label.new(mt, entryPrice, "NO RESULT", xloc=xloc.bar_time, style=label.style_label_left, color=color.gray, textcolor=color.white)

            tradeActive := false

//====================================================
// Results Table
//====================================================
var table t = table.new(position.top_right, 2, 6, border_width=1)

if showTable and barstate.islast
    int totalW = longW + shortW
    int totalL = longL + shortL

    float totalWR = pct(totalW, totalW + totalL)
    float longWR  = pct(longW, longW + longL)
    float shortWR = pct(shortW, shortW + shortL)

    table.clear(t, 0, 0)
    table.cell(t, 0, 0, "Metric", bgcolor=color.black, text_color=color.white)
    table.cell(t, 1, 0, "Value",  bgcolor=color.black, text_color=color.white)
    table.cell(t, 0, 1, "Long (W/L/N)")
    table.cell(t, 1, 1, str.format("{0}/{1}/{2}", longW, longL, longN))
    table.cell(t, 0, 2, "Short (W/L/N)")
    table.cell(t, 1, 2, str.format("{0}/{1}/{2}", shortW, shortL, shortN))
    table.cell(t, 0, 3, "Win Rate Total (excl N)")
    table.cell(t, 1, 3, na(totalWR) ? "n/a" : str.format("{0,number,#.##}%", totalWR))
    table.cell(t, 0, 4, "Win Rate Long (excl N)")
    table.cell(t, 1, 4, na(longWR) ? "n/a" : str.format("{0,number,#.##}%", longWR))
    table.cell(t, 0, 5, "Win Rate Short (excl N)")
    table.cell(t, 1, 5, na(shortWR) ? "n/a" : str.format("{0,number,#.##}%", shortWR))
